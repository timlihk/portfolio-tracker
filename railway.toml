[build]
builder = "NIXPACKS"
buildCommand = "DATABASE_URL=${DATABASE_URL:-$DATABASE_PUBLIC_URL} npm install --prefix backend && DATABASE_URL=${DATABASE_URL:-$DATABASE_PUBLIC_URL} npx --prefix backend prisma generate && npm run build:all"

[deploy]
startCommand = "cd backend && DATABASE_URL=${DATABASE_URL:-$DATABASE_PUBLIC_URL} npx prisma db push --skip-generate --accept-data-loss || echo 'DB push completed or skipped' && DATABASE_URL=${DATABASE_URL:-$DATABASE_PUBLIC_URL} node dist/main.js"

[[services]]
name = "portfolio-tracker"
healthCheckPath = "/api/healthz"

[services.env]
NODE_ENV = "production"
PORT = "8080"
DATABASE_URL = "${DATABASE_URL}"
JWT_SECRET = "${JWT_SECRET}"

[[services.ports]]
port = 8080
protocol = "http"

[[databases]]
name = "mangrove-db"
type = "postgresql"
